<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Player;
use Doctrine\ORM\EntityRepository;

/**
 * PlayerRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PlayerRepository extends EntityRepository
{
    public function getGamesPlayed(Player $player)
    {
        return $this->createQueryBuilder('player')
            ->leftJoin('player', 'result');
    }

    public function findAllLeaguePlayers()
    {
        return $this->findBy(['leaguePlayer' => true]);
    }

    /**
     * @return int
     */
    public function getNoOfGamesAllPlayed(): int
    {
        $qb = $this->createQueryBuilder('player');
        $expr = $qb->expr();
        $result = $qb
            ->select('COUNT(r.id) as games_played')
            ->innerJoin('player.results', 'r')
            ->innerJoin('r.game', 'g')
            ->andWhere($expr->eq('g.isLeague', true))
            ->andWhere($expr->eq('player.leaguePlayer', true))
            ->groupBy('player.id')
            ->orderBy('games_played', 'ASC')
            ->setMaxResults(1)
            ->getQuery()
            ->getResult();
        return $result[0]['games_played'];
    }
}
